<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitwarden De-duplicator | Secure Vault Optimization</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6;
            --primary-light: #60a5fa;
            --bg: #0a0f1d;
            --surface: #161d31;
            --surface-hover: #1e273e;
            --header-bg: #1e273e;
            --sidebar-bg: #111827;
            --border: #283046;
            --text: #d0d2d6;
            --text-heading: #f8fafc;
            --text-muted: #b4b7bd;
            --danger: #ea5455;
            --success: #28c76f;
            --accent: #7367f0;
            --sidebar-w: 280px;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline-color: var(--primary);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            line-height: 1.5;
        }

        h1,
        h2,
        h3,
        h4 {
            font-family: 'Outfit', sans-serif;
            color: var(--text-heading);
            font-weight: 600;
        }

        /* Layout Structure */
        .app-shell {
            display: grid;
            grid-template-columns: var(--sidebar-w) 1fr;
            grid-template-rows: 70px 1fr;
            height: 100vh;
            width: 100vw;
        }

        /* Top Navbar */
        .navbar {
            grid-column: 1 / -1;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            z-index: 100;
            box-shadow: 0 4px 20px 0 rgba(0, 0, 0, .05);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .brand-logo {
            font-size: 1.5rem;
        }

        .brand-text {
            font-size: 1.25rem;
            letter-spacing: -0.5px;
        }

        .nav-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Sidebar Navigation */
        .sidebar {
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-search {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .search-input {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.6rem 0.75rem;
            border-radius: 8px;
            font-size: 0.85rem;
            transition: var(--transition);
        }

        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 0.25rem;
            transition: var(--transition);
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .nav-item:hover {
            background: var(--surface);
            color: var(--text-heading);
        }

        .nav-item.active {
            background: var(--primary);
            color: #fff;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .nav-item .count {
            font-size: 0.75rem;
            background: rgba(255, 255, 255, 0.15);
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        /* Main Content Viewport */
        .viewport {
            background: var(--bg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Fixed Toolbar */
        .toolbar {
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
        }

        .action-group {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        /* Select Bar (Contextual) */
        .selection-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--primary);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            transform: translateY(-100%);
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 90;
        }

        .selection-bar.visible {
            transform: translateY(0);
        }

        .content-shifter {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
        }

        .content-shifter.shifted {
            transform: translateY(60px);
        }

        /* Table Container */
        .table-wrap {
            flex: 1;
            overflow: auto;
            margin: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--surface);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            /* Prevents columns from shifting */
        }

        thead th {
            background: var(--header-bg);
            color: var(--text-heading);
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            padding: 1rem;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 80;
            border-bottom: 2px solid var(--border);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        th:nth-child(1) {
            width: 50px;
        }

        th:nth-child(2) {
            width: 40%;
        }

        th:nth-child(3) {
            width: 22%;
        }

        th:nth-child(4) {
            width: 22%;
        }

        th:nth-child(5) {
            width: 140px;
        }

        tbody tr {
            border-bottom: 1px solid var(--border);
            transition: var(--transition);
            cursor: pointer;
        }

        tbody tr:hover {
            background: var(--surface-hover);
        }

        tbody tr.selected {
            background: rgba(59, 130, 246, 0.08);
        }

        tbody tr.deleted {
            opacity: 0.4;
        }

        td {
            padding: 1rem;
            vertical-align: middle;
            text-align: left;
        }

        .action-cell {
            text-align: center;
            width: 140px;
        }

        .checkbox-cell {
            width: 50px;
            text-align: center;
        }

        /* Data Presentation */
        .field-box {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .field-label {
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--text-muted);
        }

        .field-value {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-heading);
        }

        /* Truncation & Popover System */
        .truncator {
            position: relative;
            max-width: 100%;
        }

        .truncator-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
            cursor: help;
        }

        .truncator-popover {
            position: absolute;
            top: -8px;
            left: -8px;
            padding: 8px;
            background: var(--surface);
            border: 1px solid var(--border);
            opacity: 0;
            pointer-events: none;
            z-index: 200;
            width: max-content;
            min-width: 100%;
            max-width: 400px;
            white-space: normal;
            word-break: break-all;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            transition: opacity 0.1s ease;
            color: var(--text-heading);
            font-size: inherit;
        }

        .truncator:hover .truncator-popover {
            opacity: 1;
            pointer-events: auto;
        }

        .field-sub {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .password-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            position: relative;
        }

        .password-val {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            letter-spacing: 1px;
            color: var(--primary-light);
            display: block;
        }


        /* Buttons & Inputs */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            border: none;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-outline:hover {
            background: var(--surface-hover);
            border-color: var(--text-muted);
        }

        .select-sm {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.5rem 2rem 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.85rem;
            appearance: none;
            cursor: pointer;
        }

        /* Checkbox Styling */
        .checkbox-cell {
            width: 50px;
            text-align: center;
        }

        .custom-checkbox {
            width: 1.2rem;
            height: 1.2rem;
            appearance: none;
            border: 2px solid var(--border);
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            transition: var(--transition);
            background: var(--bg);
        }

        .custom-checkbox:checked {
            background: var(--primary);
            border-color: var(--primary);
        }

        .custom-checkbox:checked::after {
            content: '✓';
            position: absolute;
            color: #fff;
            font-size: 0.8rem;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        /* Upload States */
        .upload-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(20px);
        }

        .drop-zone {
            padding: 4rem;
            border: 2px dashed var(--border);
            border-radius: 2rem;
            background: var(--surface);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .drop-zone:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .hidden {
            display: none !important;
        }

        /* Accessibility: Skip to content */
        .skip-link {
            position: absolute;
            top: -100px;
            left: 0;
            background: var(--primary);
            color: #fff;
            padding: 1rem;
            z-index: 2000;
            transition: top 0.2s;
        }

        .skip-link:focus {
            top: 0;
        }
    </style>
</head>

<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div id="uploadOverlay" class="upload-overlay">
        <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
            <div>
                <h1 style="margin-bottom: 0.5rem;">Import Bitwarden Export</h1>
                <p style="color: var(--text-muted);">Drop your .json file here to start cleaning.</p>
            </div>
            <button class="btn btn-primary">Choose File</button>
            <input type="file" id="fileInput" accept=".json" class="hidden">
        </div>
    </div>

    <div class="app-shell hidden" id="app">
        <nav class="navbar" role="navigation">
            <div class="brand">
                <h1 class="brand-text">Bitwarden <span style="font-weight: 300; opacity: 0.7;">Deduplicator</span></h1>
            </div>
            <div class="nav-actions">
                <div id="statSummary" style="font-size: 0.85rem; color: var(--text-muted); display: flex; gap: 1.5rem;">
                    <span>Total: <strong id="totalCount" style="color: var(--text-heading)">0</strong></span>
                    <span>Removed: <strong id="removedCount" style="color: var(--danger)">0</strong></span>
                </div>
                <button class="btn btn-primary" onclick="downloadJSON()">Export cleaned</button>
            </div>
        </nav>

        <aside class="sidebar">
            <div class="sidebar-search">
                <input type="text" class="search-input" placeholder="Search domains..." id="sidebarSearch"
                    oninput="renderSidebar()">
            </div>
            <nav class="sidebar-nav" id="sidebarList" aria-label="Groups by Domain">
                <!-- Groups generate here -->
            </nav>
        </aside>

        <main class="viewport" id="main-content">
            <div class="selection-bar" id="selectionBar">
                <span id="selectionText" style="font-weight: 600;">0 items selected</span>
                <div class="action-group">
                    <button id="selectionRestoreBtn" class="btn btn-outline"
                        style="background: rgba(255,255,255,0.1); border:none;" onclick="bulkAction(false)">Restore
                        selection</button>
                    <button id="selectionDeleteBtn" class="btn btn-primary"
                        style="background: var(--danger); box-shadow: none;" onclick="bulkAction(true)">Delete
                        selection</button>
                    <button class="btn btn-outline" style="color: #fff; border:none;"
                        onclick="clearSelection()">Cancel</button>
                </div>
            </div>

            <div class="content-shifter" id="contentShifter">
                <div class="toolbar">
                    <div class="action-group">
                        <h2 id="tabTitle" style="font-size: 1.5rem;">Everything</h2>
                    </div>
                    <div class="action-group">
                        <div class="field-box" style="gap: 5px;">
                            <span class="field-label">Delete strategy</span>
                            <select id="dedupeMode" class="select-sm">
                                <option value="domain_all">Domain + User + Pass</option>
                                <option value="url_all">Full URL + User + Pass</option>
                                <option value="name_all">Site Name + User + Pass</option>
                                <option value="user_pass">User + Pass (Global)</option>
                                <option value="user">Username Only</option>
                                <option value="incomplete">Incomplete (Empty User/Pass)</option>
                            </select>
                        </div>
                        <button class="btn btn-outline" onclick="toggleBulkReveal()" style="margin-top: 15px;"
                            id="bulkRevealBtn">
                            Reveal all passwords
                        </button>
                        <button class="btn btn-outline" onclick="autoDedupe()" style="margin-top: 15px;">
                            Run auto-delete
                        </button>
                    </div>
                </div>

                <div class="table-wrap">
                    <table role="grid">
                        <thead>
                            <tr>
                                <th class="checkbox-cell">
                                    <input type="checkbox" class="custom-checkbox" id="selectAll"
                                        onclick="toggleSelectAll()">
                                </th>
                                <th scope="col">Site & Label</th>
                                <th scope="col">Identity</th>
                                <th scope="col">Secret</th>
                                <th scope="col" class="action-cell">Manual Action</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        let bitwardenData = null;
        let activeTab = 'all';
        let originalFileName = "";
        let hasUnsavedChanges = false;
        let selectedIndices = new Set();
        let showPasswords = new Set();
        let showAllPasswords = false;

        const fileInput = document.getElementById('fileInput');
        const uploadOverlay = document.getElementById('uploadOverlay');
        const app = document.getElementById('app');
        const itemsTableBody = document.getElementById('itemsTableBody');
        const sidebarList = document.getElementById('sidebarList');
        const selectionBar = document.getElementById('selectionBar');

        fileInput.addEventListener('change', handleFile);

        document.body.addEventListener('dragover', (e) => e.preventDefault());
        document.body.addEventListener('drop', (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file) handleFile({ target: { files: [file] } });
        });

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            originalFileName = file.name;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    bitwardenData = JSON.parse(event.target.result);
                    if (!bitwardenData.items) throw new Error("This doesn't look like a Bitwarden export.");

                    bitwardenData.items.forEach(item => item._isDeleted = false);
                    uploadOverlay.classList.add('hidden');
                    app.classList.remove('hidden');
                    renderSidebar();
                    renderTable();
                } catch (err) {
                    alert("Error: " + err.message);
                }
            };
            reader.readAsText(file);
        }

        function getBaseUrl(item) {
            if (item.type !== 1) return "System Info";
            const login = item.login || {};
            if (!login.uris || login.uris.length === 0) return "No Domain";

            try {
                let raw = login.uris[0].uri || "";
                if (!raw.includes('://')) raw = 'http://' + raw;
                return new URL(raw).hostname.replace('www.', '');
            } catch { return "Misc URL"; }
        }

        function renderSidebar() {
            const filter = document.getElementById('sidebarSearch').value.toLowerCase();
            const groups = { 'all': 0 };
            bitwardenData.items.forEach(item => {
                const url = getBaseUrl(item);
                groups[url] = (groups[url] || 0) + 1;
                groups['all']++;
            });

            const sortedKeys = Object.keys(groups)
                .filter(k => k.toLowerCase().includes(filter))
                .sort((a, b) => {
                    if (a === 'all') return -1;
                    if (b === 'all') return 1;
                    return groups[b] - groups[a];
                });

            sidebarList.innerHTML = sortedKeys.map(key => `
                <div class="nav-item ${activeTab === key ? 'active' : ''}" onclick="setTab('${key}')">
                    <span>${key === 'all' ? 'All Items' : key}</span>
                    <span class="count">${groups[key]}</span>
                </div>
            `).join('');
        }

        function setTab(key) {
            activeTab = key;
            document.getElementById('tabTitle').textContent = key === 'all' ? 'Everything' : key;
            selectedIndices.clear();
            renderSidebar();
            renderTable();
        }

        function renderTable() {
            const filtered = bitwardenData.items.map((item, index) => ({ item, index }))
                .filter(entry => activeTab === 'all' || getBaseUrl(entry.item) === activeTab);

            const rowsHtml = filtered.map(({ item, index }) => {
                const login = item.login || {};
                const name = item.name || 'Unnamed';
                const uri = (login.uris && login.uris.length > 0) ? login.uris[0].uri : "N/A";
                const isRevealed = showAllPasswords !== showPasswords.has(index);
                const isSelected = selectedIndices.has(index);
                const isDeleted = item._isDeleted;

                return `
                    <tr id="row-${index}" class="${isDeleted ? 'deleted' : ''} ${isSelected ? 'selected' : ''}" onclick="toggleSelect(${index})">
                        <td class="checkbox-cell">
                            <input type="checkbox" class="custom-checkbox" 
                                   ${isSelected ? 'checked' : ''} 
                                   onclick="event.stopPropagation(); toggleSelect(${index})">
                        </td>
                        <td>
                            <div class="field-box">
                                <span class="field-value">${name}</span>
                                <div class="truncator field-sub">
                                    <span class="truncator-text">${uri}</span>
                                    <span class="truncator-popover">${uri}</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="field-box">
                                <span class="field-value" style="${!login.username ? 'color:var(--danger); font-style:italic;' : ''}">
                                    ${login.username || 'Empty'}
                                </span>
                            </div>
                        </td>
                        <td>
                            <div class="field-box">
                                <div class="password-container" style="display:flex; justify-content:space-between; align-items:center;">
                                    <div class="truncator password-val" style="flex:1; margin-right:8px;">
                                        <span class="truncator-text">${isRevealed ? (login.password || 'none') : '••••••••'}</span>
                                        <span class="truncator-popover">${isRevealed ? (login.password || 'none') : '••••••••'}</span>
                                    </div>
                                    <button class="btn btn-outline" style="padding:2px 6px; font-size:10px; flex-shrink: 0;" 
                                            onclick="event.stopPropagation(); togglePassword(${index})">
                                        ${isRevealed ? 'Hide' : 'Show'}
                                    </button>
                                </div>
                            </div>
                        </td>
                        <td class="action-cell">
                            <button class="btn ${isDeleted ? 'btn-outline' : 'btn-danger'}" 
                                    style="padding: 0.4rem 0.8rem; width: 100px; justify-content: center;"
                                    onclick="event.stopPropagation(); toggleItem(${index})">
                                ${isDeleted ? 'Restore' : 'Delete'}
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            itemsTableBody.innerHTML = rowsHtml;
            updateStats();
            updateSelectionBar();
        }

        function togglePassword(idx) {
            if (showPasswords.has(idx)) showPasswords.delete(idx);
            else showPasswords.add(idx);

            // Localized update for the specific row's password cell
            const row = document.getElementById(`row-${idx}`);
            if (row) {
                const isRevealed = showAllPasswords !== showPasswords.has(idx);
                const login = bitwardenData.items[idx].login || {};
                const text = isRevealed ? (login.password || 'none') : '••••••••';

                const container = row.querySelector('.password-container');
                const tText = container.querySelector('.truncator-text');
                const tPop = container.querySelector('.truncator-popover');
                const btn = container.querySelector('button');

                if (tText) tText.textContent = text;
                if (tPop) tPop.textContent = text;
                if (btn) btn.textContent = isRevealed ? 'Hide' : 'Show';
            }
        }

        function toggleBulkReveal() {
            showAllPasswords = !showAllPasswords;
            showPasswords.clear(); // Reset individual overrides when switching global mode
            const btn = document.getElementById('bulkRevealBtn');
            btn.textContent = showAllPasswords ? 'Hide all passwords' : 'Reveal all passwords';
            renderTable();
        }

        function toggleSelect(idx) {
            if (selectedIndices.has(idx)) selectedIndices.delete(idx);
            else selectedIndices.add(idx);

            // Localized update to avoid full re-render
            const row = document.getElementById(`row-${idx}`);
            if (row) {
                const isSelected = selectedIndices.has(idx);
                row.classList.toggle('selected', isSelected);
                row.querySelector('input[type="checkbox"]').checked = isSelected;
            }
            updateSelectionBar();
        }

        function clearSelection() {
            selectedIndices.clear();
            document.getElementById('selectAll').checked = false;
            // Re-render to update all checkboxes and row styles
            renderTable();
        }

        function toggleSelectAll() {
            const visible = bitwardenData.items.map((item, index) => ({ item, index }))
                .filter(entry => activeTab === 'all' || getBaseUrl(entry.item) === activeTab);

            if (selectedIndices.size === visible.length) selectedIndices.clear();
            else visible.forEach(v => selectedIndices.add(v.index));
            renderTable();
        }

        function updateSelectionBar() {
            const count = selectedIndices.size;
            const visible = count > 0;
            selectionBar.classList.toggle('visible', visible);
            document.getElementById('contentShifter').classList.toggle('shifted', visible);
            document.getElementById('selectionText').textContent = `${count} items selected`;

            if (visible) {
                let hasDeleted = false;
                let hasActive = false;
                selectedIndices.forEach(idx => {
                    if (bitwardenData.items[idx]._isDeleted) hasDeleted = true;
                    else hasActive = true;
                });
                document.getElementById('selectionRestoreBtn').disabled = !hasDeleted;
                document.getElementById('selectionDeleteBtn').disabled = !hasActive;
            }
        }

        function updateStats() {
            const items = bitwardenData.items;
            const removed = items.filter(i => i._isDeleted).length;
            document.getElementById('totalCount').textContent = items.length;
            document.getElementById('removedCount').textContent = removed;
        }

        function toggleItem(idx) {
            bitwardenData.items[idx]._isDeleted = !bitwardenData.items[idx]._isDeleted;
            hasUnsavedChanges = true;
            renderTable();
            renderSidebar();
        }

        function bulkAction(shouldScrub) {
            selectedIndices.forEach(idx => { bitwardenData.items[idx]._isDeleted = shouldScrub; });
            hasUnsavedChanges = true;
            clearSelection();
        }

        function autoDedupe() {
            const mode = document.getElementById('dedupeMode').value;
            const seen = new Set();
            let count = 0;

            bitwardenData.items.forEach(item => {
                if (item._isDeleted || item.type !== 1) return;

                if (mode === 'incomplete') {
                    if (!item.login?.username || !item.login?.password) { item._isDeleted = true; count++; }
                    return;
                }

                const login = item.login || {};
                const user = (login.username || "").trim().toLowerCase();
                const pass = (login.password || "").trim();
                const name = (item.name || "").trim().toLowerCase();
                const fullUri = (login.uris && login.uris.length > 0) ? (login.uris[0].uri || "").trim().toLowerCase() : "none";
                const domain = getBaseUrl(item).toLowerCase();

                let key;
                if (mode === 'user') key = user;
                else if (mode === 'user_pass') key = `${user}|${pass}`;
                else if (mode === 'name_all') key = `${name}|${user}|${pass}`;
                else if (mode === 'url_all') key = `${fullUri}|${user}|${pass}`;
                else key = `${domain}|${user}|${pass}`; // domain_all (default)

                if (seen.has(key)) { item._isDeleted = true; count++; }
                else seen.add(key);
            });

            hasUnsavedChanges = true;
            renderTable();
            renderSidebar();
            alert(`Auto-delete complete. Marked ${count} potential duplicates for removal.`);
        }

        function downloadJSON() {
            const final = bitwardenData.items.filter(i => !i._isDeleted).map(({ _isDeleted, ...rest }) => rest);
            const blob = new Blob([JSON.stringify({ ...bitwardenData, items: final }, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = originalFileName.replace('.json', '') + '_deduped.json';
            a.click();
            hasUnsavedChanges = false;
        }

        window.onbeforeunload = (e) => { if (hasUnsavedChanges) return "You have unsaved changes!"; };
    </script>
</body>

</html>